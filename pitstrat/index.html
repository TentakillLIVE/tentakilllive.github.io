<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pit Strategy</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Light Mode Defaults */
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --mute: #64748b;
            --primary: #2563eb; 
            --input-bg: #ffffff;
            --th-bg: #f1f5f9;
            --row-hover: #f8fafc;
            
            --success-bg: #dcfce7;
            --success-text: #166534;
            --fill-bg: #dbeafe;
            --fill-text: #1e40af;
            
            --pit-row-bg: #fffbeb;
            
            --btn-bg: #ffffff;
            --btn-border: #cbd5e1;
            --btn-text: #0f172a;
        }

        [data-theme="dark"] {
            --bg: #0f172a;           
            --surface: #1e293b;      
            --border: #334155;       
            --text: #f1f5f9;         
            --mute: #94a3b8;         
            --primary: #3b82f6;      
            --input-bg: #020617;     
            --th-bg: #0f172a;        
            --row-hover: #1e293b;
            
            --success-bg: #064e3b;   
            --success-text: #6ee7b7; 
            --fill-bg: #1e3a8a;      
            --fill-text: #93c5fd;    
            
            --pit-row-bg: #422006;   

            --btn-bg: #1e293b;
            --btn-border: #475569;
            --btn-text: #f8fafc;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: background 0.3s, color 0.3s; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; position: relative; }
        
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        /* --- UI COMPONENTS --- */
        
        /* Header / Buttons Area */
        .top-bar { grid-column: 1 / -1; display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 10px; margin-bottom: -10px; }
        
        .action-btn { 
            background: var(--btn-bg); border: 1px solid var(--btn-border); color: var(--btn-text); 
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        .action-btn:hover { border-color: var(--primary); opacity: 0.9; }
        .btn-danger:hover { border-color: #ef4444; color: #ef4444; }
        .btn-primary { border-color: var(--primary); color: var(--primary); }

        /* Card Styles */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-header { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--mute); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; letter-spacing: 0.05em; }

        /* Inputs */
        .config-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .field label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--mute); margin-bottom: 4px; }
        .field input { 
            width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; 
            box-sizing: border-box; font-weight: 600; background: var(--input-bg); color: var(--text); 
        }

        /* Table */
        .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 650px; }
        th { background: var(--th-bg); text-align: left; padding: 10px; font-size: 0.7rem; font-weight: 700; color: var(--mute); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        
        input.grid-input { 
            width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; 
            font-variant-numeric: tabular-nums; background: var(--input-bg); color: var(--text); 
        }
        input.grid-input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Pit Styling */
        .pit-check { width: 18px; height: 18px; accent-color: var(--primary); display: block; margin: 0 auto; cursor: pointer; }
        tr.pit-active { background-color: var(--pit-row-bg); }
        .pit-exit-box { display: none; }
        tr.pit-active .pit-exit-box { display: block; }

        /* Consumption Column */
        .burn-total { font-weight: 700; font-family: monospace; font-size: 1rem; }
        .burn-sub { font-size: 0.7rem; color: var(--mute); display: block; margin-top: 2px; }

        /* Strategy List */
        .strat-list { list-style: none; padding: 0; margin: 0; }
        .strat-item { padding: 12px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .strat-item:last-child { border-bottom: none; }
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        
        /* Tags adapt to theme */
        .tag-fill { background: var(--fill-bg); color: var(--fill-text); }
        .tag-finish { background: var(--success-bg); color: var(--success-text); }

        /* Big Metrics */
        .big-val { font-size: 2rem; font-weight: 800; line-height: 1; color: var(--text); }
        .big-lbl { font-size: 0.75rem; color: var(--mute); font-weight: 500; margin-top: 5px; text-transform: uppercase; }

        /* Hidden File Input */
        #fileInput { display: none; }

    </style>
</head>
<body>

<div class="container">
    
    <div class="top-bar">
        <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
        
        <button class="action-btn btn-primary" onclick="exportData()">
            ‚¨áÔ∏è Export
        </button>
        <button class="action-btn btn-primary" onclick="document.getElementById('fileInput').click()">
            ‚¨ÜÔ∏è Import
        </button>
        <button class="action-btn btn-danger" onclick="clearAllData()">
            üóëÔ∏è Reset
        </button>
        <button class="action-btn" onclick="toggleTheme()">
            <span id="themeIcon">‚òÄÔ∏è</span> <span id="themeText">Light</span>
        </button>
    </div>

    <div style="display:flex; flex-direction:column; gap:20px;">
        
        <div class="card">
            <div class="card-header">Race Setup</div>
            <div class="config-row">
                <div class="field">
                    <label>Total Laps</label>
                    <input type="number" id="cfgLaps" value="30" step="1" oninput="handleConfigChange()">
                </div>
                <div class="field">
                    <label>Tank Size (L)</label>
                    <input type="number" id="cfgTank" value="100" step="0.1" oninput="recalc()">
                </div>
                <div class="field">
                    <label>Margin (L)</label>
                    <input type="number" id="cfgMargin" value="1" step="0.1" oninput="recalc()">
                </div>
            </div>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width:70px;">Lap</th>
                            <th>Start Fuel</th>
                            <th>Pit Entry Fuel</th>
                            <th style="text-align:center; width:50px;">Pit?</th>
                            <th>Pit Exit Fuel</th>
                            <th>Lap Consumption</th>
                        </tr>
                    </thead>
                    <tbody id="grid"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div style="display:flex; flex-direction:column; gap:20px;">
        
        <div class="card">
            <div class="card-header">Live Telemetry</div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 20px;">
                <div>
                    <div class="big-val" id="dispAvg">--</div>
                    <div class="big-lbl">Full Lap Burn</div>
                </div>
                <div>
                    <div class="big-val" id="dispOutLap">--</div>
                    <div class="big-lbl">Out-Lap Burn</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div class="big-val" id="dispFuel">--</div>
                <div class="big-lbl">Current Fuel (L)</div>
            </div>

            <div>
                <div class="big-val" id="dispRange">--</div>
                <div class="big-lbl">Est. Laps Remaining</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Projected Strategy</div>
            <ul class="strat-list" id="stratList">
                <li class="strat-item" style="color:var(--mute); font-style:italic;">Awaiting Lap 1 Data...</li>
            </ul>
        </div>

    </div>

</div>

<script>
    // --- THEME LOGIC ---
    function initTheme() {
        const saved = localStorage.getItem('raceTheme') || 'dark';
        document.documentElement.setAttribute('data-theme', saved);
        updateThemeBtn(saved);
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('raceTheme', next);
        updateThemeBtn(next);
    }

    function updateThemeBtn(theme) {
        const icon = document.getElementById('themeIcon');
        const text = document.getElementById('themeText');
        if (theme === 'dark') {
            icon.innerText = '‚òÄÔ∏è';
            text.innerText = 'Light';
        } else {
            icon.innerText = 'üåô';
            text.innerText = 'Dark';
        }
    }

    // --- DATA PERSISTENCE & IMPORT/EXPORT ---
    
    function collectData() {
        // Gather Config
        const cfg = {
            laps: document.getElementById('cfgLaps').value,
            tank: document.getElementById('cfgTank').value,
            margin: document.getElementById('cfgMargin').value
        };

        // Gather Grid
        const rows = [];
        for (let i = 1; i <= maxRow; i++) {
            const start = document.getElementById(`start-${i}`)?.value;
            const end = document.getElementById(`end-${i}`)?.value;
            const check = document.getElementById(`check-${i}`)?.checked;
            const exit = document.getElementById(`exit-${i}`)?.value;
            
            if (i===1 || start || end || check || exit) {
                rows.push({ i, start, end, check, exit });
            }
        }
        return { cfg, rows, timestamp: new Date().toISOString() };
    }

    function saveData() {
        const data = collectData();
        localStorage.setItem('raceData', JSON.stringify(data));
    }

    function exportData() {
        const data = collectData();
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `race_strategy_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // Validate JSON parsing
                const json = JSON.parse(e.target.result);
                if(!json.cfg || !json.rows) throw new Error("Invalid Format");
                
                // Save to local storage and reload
                localStorage.setItem('raceData', JSON.stringify(json));
                location.reload();
            } catch(err) {
                alert("Error importing file: Invalid JSON structure.");
            }
        };
        reader.readAsText(file);
    }

    function loadData() {
        const raw = localStorage.getItem('raceData');
        if (!raw) {
            spawnRow(1);
            return;
        }

        const data = JSON.parse(raw);
        
        if(data.cfg) {
            if(data.cfg.laps) document.getElementById('cfgLaps').value = data.cfg.laps;
            if(data.cfg.tank) document.getElementById('cfgTank').value = data.cfg.tank;
            if(data.cfg.margin) document.getElementById('cfgMargin').value = data.cfg.margin;
        }

        if(data.rows && data.rows.length > 0) {
            data.rows.forEach(r => {
                spawnRow(r.i);
                if (document.getElementById(`start-${r.i}`)) document.getElementById(`start-${r.i}`).value = r.start || '';
                if (document.getElementById(`end-${r.i}`)) document.getElementById(`end-${r.i}`).value = r.end || '';
                if (document.getElementById(`exit-${r.i}`)) document.getElementById(`exit-${r.i}`).value = r.exit || '';
                if (document.getElementById(`check-${r.i}`)) {
                    document.getElementById(`check-${r.i}`).checked = r.check || false;
                    togglePit(r.i); 
                }
            });
            const last = data.rows[data.rows.length - 1];
            handleInput(last.i); 
        } else {
            spawnRow(1);
        }
        recalc();
    }

    function clearAllData() {
        if(confirm("Are you sure you want to reset all race data? This cannot be undone.")) {
            localStorage.removeItem('raceData');
            location.reload(); 
        }
    }

    // --- INIT ---
    const grid = document.getElementById('grid');
    let maxRow = 0;

    window.onload = () => {
        initTheme();
        loadData();
    };

    function handleConfigChange() {
        recalc();
        saveData();
    }

    // --- GRID MANAGEMENT ---
    function spawnRow(lapNum) {
        if (document.getElementById(`row-${lapNum}`)) return;

        const totalLaps = parseFloat(document.getElementById('cfgLaps').value) || 21;
        
        if (lapNum > totalLaps + 1) return;

        let label = lapNum.toString();
        let isFinish = false;
        if (lapNum === totalLaps + 1) {
            label = "üèÅ Finish Line";
            isFinish = true;
        }

        const tr = document.createElement('tr');
        tr.id = `row-${lapNum}`;
        tr.innerHTML = `
            <td id="label-${lapNum}" style="text-align:center; font-weight:bold; color:var(--mute); font-size:0.8rem;">${label}</td>
            <td><input type="number" step="0.1" id="start-${lapNum}" class="grid-input" placeholder="Start" oninput="handleInput(${lapNum})"></td>
            
            <td>${isFinish ? '' : `<input type="number" step="0.1" id="end-${lapNum}" class="grid-input" placeholder="End" oninput="handleInput(${lapNum})">`}</td>
            <td>${isFinish ? '' : `<input type="checkbox" id="check-${lapNum}" class="pit-check" onchange="togglePit(${lapNum})">`}</td>
            <td>
                ${isFinish ? '' : `
                <div class="pit-exit-box">
                    <input type="number" step="0.1" id="exit-${lapNum}" class="grid-input" placeholder="Filled To" oninput="handleInput(${lapNum})">
                </div>`}
            </td>
            <td id="burn-${lapNum}">-</td>
        `;
        grid.appendChild(tr);
        maxRow = lapNum;
    }

    function togglePit(lapNum) {
        const row = document.getElementById(`row-${lapNum}`);
        const chk = document.getElementById(`check-${lapNum}`);
        const exitInput = document.getElementById(`exit-${lapNum}`);

        if (chk && chk.checked) {
            row.classList.add('pit-active');
            if(exitInput) exitInput.focus();
        } else {
            row.classList.remove('pit-active');
            if(exitInput) exitInput.value = '';
        }
        recalc();
        saveData();
    }

    function handleInput(lapNum) {
        const start = getVal(`start-${lapNum}`);
        const end = getVal(`end-${lapNum}`);
        const chk = document.getElementById(`check-${lapNum}`);
        const isPit = chk ? chk.checked : false;
        const exit = getVal(`exit-${lapNum}`);

        let rowComplete = false;
        
        if (start !== null && end !== null) {
            if (!isPit) rowComplete = true;
            if (isPit && exit !== null) rowComplete = true;
        }

        const totalLaps = parseFloat(document.getElementById('cfgLaps').value) || 21;
        if (lapNum === totalLaps + 1 && start !== null) {
            rowComplete = false; 
        }

        if (rowComplete) spawnRow(lapNum + 1);
        recalc();
        saveData();
    }

    // --- CORE LOGIC ---
    function recalc() {
        const totalLaps = parseFloat(document.getElementById('cfgLaps').value) || 50;
        const tankSize = parseFloat(document.getElementById('cfgTank').value) || 100;
        const margin = parseFloat(document.getElementById('cfgMargin').value) || 0;
        const finishLineIndex = totalLaps + 1;

        // Label update
        for(let i=1; i<=maxRow; i++) {
            const lbl = document.getElementById(`label-${i}`);
            if(lbl) {
                if(i === finishLineIndex) lbl.innerText = "üèÅ Finish Line";
                else lbl.innerText = i;
            }
        }

        let sumFullLap = 0;
        let countFullLap = 0;
        let sumOutLap = 0;
        let countOutLap = 0;
        let currentFuel = null;
        let currentLap = 0;

        // 1. DATA COLLECTION
        for (let i = 1; i <= maxRow; i++) {
            const start = getVal(`start-${i}`);
            const end = getVal(`end-${i}`);
            const chk = document.getElementById(`check-${i}`);
            const isPit = chk ? chk.checked : false;
            const exit = getVal(`exit-${i}`);
            const nextStart = getVal(`start-${i+1}`);
            
            const cell = document.getElementById(`burn-${i}`);
            let displayHTML = "-";

            if (isPit) {
                if (start !== null && end !== null && exit !== null && nextStart !== null) {
                    const legIn = start - end; 
                    const legOut = exit - nextStart; 
                    const totalPitLap = legIn + legOut;
                    
                    if(legOut > 0) {
                        sumOutLap += legOut;
                        countOutLap++;
                    }
                    sumFullLap += totalPitLap;
                    countFullLap++;

                    displayHTML = `
                        <div class="burn-total">${totalPitLap.toFixed(2)}</div>
                        <span class="burn-sub">Out-Lap: ${legOut.toFixed(2)}</span>
                    `;
                }
            } else {
                if (start !== null && nextStart !== null) {
                    const burn = start - nextStart;
                    if(burn > 0) {
                        sumFullLap += burn;
                        countFullLap++;
                    }
                    displayHTML = `<div class="burn-total" style="color:var(--text)">${burn.toFixed(2)}</div>`;
                }
            }
            
            if(cell) cell.innerHTML = displayHTML;

            // Update Current Status
            if (start !== null) { currentFuel = start; currentLap = i; }
            if (end !== null) { currentFuel = end; currentLap = i; }
            if (isPit && exit !== null) { currentFuel = exit; currentLap = i; }
        }

        // 2. AVERAGES
        let avgFull = 0;
        if (countFullLap > 0) avgFull = sumFullLap / countFullLap;

        let avgOut = 0;
        if (countOutLap > 0) {
            avgOut = sumOutLap / countOutLap;
        } else {
            avgOut = avgFull; 
        }

        document.getElementById('dispAvg').innerText = avgFull > 0 ? avgFull.toFixed(2) : "--";
        document.getElementById('dispOutLap').innerText = countOutLap > 0 ? avgOut.toFixed(2) : "--";
        document.getElementById('dispFuel').innerText = currentFuel !== null ? currentFuel.toFixed(1) : "--";

        // 3. STRATEGY ENGINE
        const stratList = document.getElementById('stratList');

        if (avgFull > 0 && currentFuel !== null) {
            const usable = currentFuel - margin;
            const lapsRem = Math.floor(usable / avgFull);
            const displayLapsRem = lapsRem < 0 ? 0 : lapsRem;

            document.getElementById('dispRange').innerText = displayLapsRem;

            const projectedEnd = currentLap + displayLapsRem;
            
            // --- PROJECTION LOOP ---
            let simLap = currentLap;
            let simRange = displayLapsRem;
            let html = "";
            let safety = 0;

            if (simLap >= finishLineIndex) {
                stratList.innerHTML = `<li class="strat-item" style="justify-content:center; font-weight:bold; color:var(--success-text);">üèÅ Race Finished üèÅ</li>`;
                return;
            }

            if (simLap + simRange >= finishLineIndex) {
                 stratList.innerHTML = `<li class="strat-item" style="justify-content:center; color:var(--success-text); font-weight:bold;">No stops needed. Go to finish.</li>`;
                 return;
            }

            while (simLap + simRange < finishLineIndex && safety < 10) {
                safety++;
                const pitLap = simLap + simRange;
                const lapsLeftAfter = finishLineIndex - pitLap; 
                const fullLapsNeeded = lapsLeftAfter - 1;
                
                let fuelNeeded = 0;
                if (fullLapsNeeded <= 0) {
                    fuelNeeded = avgOut + margin;
                } else {
                    fuelNeeded = (fullLapsNeeded * avgFull) + avgOut + margin;
                }
                
                let fillVal = 0;
                let tagType = "";
                let tagTxt = "";

                if (fuelNeeded > tankSize) {
                    fillVal = tankSize;
                    tagType = "tag-fill";
                    tagTxt = "Max Fill";
                    simLap = pitLap;
                    simRange = Math.floor((tankSize - margin) / avgFull);
                } else {
                    fillVal = fuelNeeded;
                    tagType = "tag-finish";
                    tagTxt = "To Finish";
                    simLap = pitLap;
                    simRange = totalLaps + 100;
                }

                const safeFill = Math.ceil(fillVal * 10) / 10;

                html += `
                    <li class="strat-item">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">Lap ${pitLap}</div>
                            <div style="font-size:0.8rem; color:var(--mute);">Planned Stop</div>
                        </div>
                        <div style="text-align:right;">
                            <span class="tag ${tagType}">${tagTxt}</span>
                            <div style="font-size:0.9rem; margin-top:4px;">Add to: <strong>${safeFill.toFixed(1)}L</strong></div>
                            ${tagTxt === "To Finish" ? `<div style="font-size:0.7rem; color:var(--mute);">(Using Out-Lap data)</div>` : ''}
                        </div>
                    </li>
                `;
            }
            stratList.innerHTML = html;

        } else {
            document.getElementById('dispRange').innerText = "--";
            stratList.innerHTML = `<li class="strat-item" style="color:var(--mute); font-style:italic;">Collect Lap 1 Data...</li>`;
        }
    }

    function getVal(id) {
        const el = document.getElementById(id);
        if (!el || el.value === "") return null;
        return parseFloat(el.value);
    }
</script>

</body>
</html>